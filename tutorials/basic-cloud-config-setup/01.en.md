---
SPDX-License-Identifier: MIT
path: "/tutorials/basic-cloud-config-setup"
slug: "basic-cloud-config-setup"
date: "2019-06-06"
title: "Basic cloud config setup"
short_description: "How to setup a new cloud server with basic configuration."
tags: ["Cloud", "SSH", "Linux", "OpenSSH"]
author: "Carsten"
author_link: "https://github.com/carstev"
author_img: "https://avatars3.githubusercontent.com/u/51443165?s=460&v=4"
author_description: ""
language: "en"
available_languages: ["en", "de"]
header_img: ""
---

## Introduction

An additional feature during creation of a cloud server (CX11 and above) is the user data.\
It allows to submit _cloud-init_ configuration for the newly created server to execute.

After following this guide, you will be able to customize the setup of new cloud servers with properly formatted config.

Parts of the configuration are based on [Securing the SSH service](/tutorials/securing-ssh).

## Step 1 - First line

_cloud-init_ config uses YAML ("YAML Ain't Markup Language") as markup language.

It should start with a comment on the first line:

```yaml
#cloud-config
```

## Step 2 - Create user

After the initial comment, let us start by creating a new admin user with sudo privileges and pre-configured SSH key.\
[How to create the SSH key pair?](/tutorials/securing-ssh#step-3---certificate-based-authentication)

```yaml
users:
  - name: holu
    groups: users, admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - <public_ssh_key>
```

## Step 3 – Run commands

_cloud-init_ allows us to run commands right after the server has been created.

Start the process by typing `runcmd:` on a new line.

### Step 3.1 - Package updates

Each command is written to a new line, preceded by a hyphen.

The first thing we do is an update of the package lists and installed packages.\
A fresh copy of Linux may have outdated packages without critical security updates.

This guide uses _apt-get_. You might need to adapt the commands depending on the package manager used.\
Since all commands will be executed as the _root_ user, we do not need `sudo` in this case.

```yaml
  - apt-get update && apt-get dist-upgrade -y
```

### Step 3.2 – Install fail2ban

With state-of-the-art package lists, we are able to install something new.

To secure the SSH network protocol a bit, we use _fail2ban_.\
By default, it will ban attackers for 10 minutes – after 5 failed login attempts within 10 minutes.

[More about this step.](/tutorials/securing-ssh#step-2---setup-of-fail2ban)

```yaml
  - apt-get install fail2ban
  - printf "[sshd]\nenabled = true\nbanaction = iptables-multiport" > /etc/fail2ban/jail.local
  - systemctl enable fail2ban
```

### Step 3.3 – Harden SSH

The last sequence of commands is dedicated to securing SSH.

We use the command `sed` to customize parts of the _sshd_config_ file.

Changes made:

- [Deactivate the root login](/tutorials/securing-ssh#step-11---deactivate-the-root-login)
- [Enable user for SSH](/tutorials/securing-ssh#step-13---enable-user-for-ssh)
- [Automatic disconnection in case of incorrect login](/securing-ssh#step-15---automatic-disconnection-in-case-of-incorrect-login)
- [Deactivate unused functions](/tutorials/securing-ssh#step-16---deactivate-unused-functions)

Feel free to add custom changes to this list.

```yaml
  - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '/^X11Forwarding/s/^.*$/X11Forwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#MaxAuthTries/s/^.*$/MaxAuthTries 2/' /etc/ssh/sshd_config
  - sed -i -e '/^#AllowTcpForwarding/s/^.*$/AllowTcpForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#AllowAgentForwarding/s/^.*$/AllowAgentForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#AuthorizedKeysFile/s/^.*$/AuthorizedKeysFile .ssh/authorized_keys/' /etc/ssh/sshd_config
  - sed -i '$a AllowUsers carstev' /etc/ssh/sshd_config
```

### Step 3.4 - Reboot

Got you! We do have one last command to execute: `reboot`

Why? Three flies with one clap:

1. After package updates, there might be a reboot necessary for patches to work properly.
2. _fail2ban_ needs a restart to take care of SSH, since we enabled the protection.
3. To apply the new configuration of SSH.

## Step 4 – Create that server

Click on the create button to boot your secured-by-default cloud server.

After the server is created, go to _Graphs_ in the console and wait until the CPU usage shrinks to zero.\
All commands have been executed and the server has rebooted. Enjoy!

## Conclusion

Many words for 21 lines of code, huh?

But I hope you learned a ton! For example:

- Build a _cloud-init_ config from scratch.
- Create users with sudo and more.
- Run commands during first server boot.
- Utilize `sed` to edit parts of a file.

Now go ahead and build something awesome!

The complete config for your convenience:

```yaml
#cloud-config
users:
  - name: holu
    groups: users, admin
    sudo: ALL=(ALL) NOPASSWD:ALL
    shell: /bin/bash
    ssh_authorized_keys:
      - <public_ssh_key>
runcmd:
  - apt-get update && apt-get dist-upgrade -y
  - apt-get install fail2ban
  - printf "[sshd]\nenabled = true\nbanaction = iptables-multiport" > /etc/fail2ban/jail.local
  - systemctl enable fail2ban
  - sed -i -e '/^PermitRootLogin/s/^.*$/PermitRootLogin no/' /etc/ssh/sshd_config
  - sed -i -e '/^X11Forwarding/s/^.*$/X11Forwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#MaxAuthTries/s/^.*$/MaxAuthTries 2/' /etc/ssh/sshd_config
  - sed -i -e '/^#AllowTcpForwarding/s/^.*$/AllowTcpForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#AllowAgentForwarding/s/^.*$/AllowAgentForwarding no/' /etc/ssh/sshd_config
  - sed -i -e '/^#AuthorizedKeysFile/s/^.*$/AuthorizedKeysFile .ssh/authorized_keys/' /etc/ssh/sshd_config
  - sed -i '$a AllowUsers carstev' /etc/ssh/sshd_config
  - reboot
```

##### License: MIT

<!---

Contributors's Certificate of Origin

By making a contribution to this project, I certify that:

(a) The contribution was created in whole or in part by me and I have
    the right to submit it under the license indicated in the file; or

(b) The contribution is based upon previous work that, to the best of my
    knowledge, is covered under an appropriate license and I have the
    right under that license to submit that work with modifications,
    whether created in whole or in part by me, under the same license
    (unless I am permitted to submit under a different license), as
    indicated in the file; or

(c) The contribution was provided directly to me by some other person
    who certified (a), (b) or (c) and I have not modified it.

(d) I understand and agree that this project and the contribution are
    public and that a record of the contribution (including all personal
    information I submit with it, including my sign-off) is maintained
    indefinitely and may be redistributed consistent with this project
    or the license(s) involved.

Signed-off-by: Carsten <hallo@carstev.de>

-->
